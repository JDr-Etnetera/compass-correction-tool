<xml xmlns="https://developers.google.com/blockly/xml"><variables><variable id="Lx)SFoC_5Q@iK/:XUMK@">compass</variable><variable id="tK-tLChTx?xz=7OxaAMQ">tmp</variable><variable id="E.CPEqpsuDy;8R3s+D,o">delta</variable><variable id="LB=Pi9-fR,#9EE35l:3y">i</variable></variables><block type="every_interval" id="m}%:bz~E;}E$OQwS=0$b" x="782" y="-312"><value name="interval"><shadow type="longTimePicker" id="jZck#6qj4PK;t-VBV|Br"><field name="ms">2000</field></shadow></value><statement name="HANDLER"><block type="function_call" id="3?J[x}[$sx|)`s#G]FE3"><mutation name="compassTick" functionid="ET7PwQ^B5=d$)w)$(V%x"><arg name="angle" id="gjc0fp9w5q7iahc22j9h4" type="number"/></mutation><value name="gjc0fp9w5q7iahc22j9h4"><shadow type="math_number" id="sA-94@wM~BJ9mmDtu^zO"><field name="NUM">1</field></shadow><block type="device_heading" id="cm~r.YI+;Ni.c:NnD*Yk"/></value><next><block type="function_call" id="7,`}6v3@Ec~H=r,e~A0$"><mutation name="debugCorrection" functionid=",Gl[Zw2[t.t){QN{Ss^Q"/></block></next></block></statement></block><block type="function_definition" id="^YBTzbYw!ibZYt.C(3Af" x="1563" y="-255"><mutation name="compassDelta" functionid="yFcY/IT0#4_MnwtS2RK/"/><field name="function_name">compassDelta</field><statement name="STACK"><block type="variables_set" id="*8w5CpW08.2f3laCSsE1"><field name="VAR" id="tK-tLChTx?xz=7OxaAMQ">tmp</field><value name="VALUE"><shadow type="math_number"><field name="NUM">0</field></shadow><block type="function_call_output" id="3:u`p+S_#D_BW//:BRRX"><mutation name="getDelta_ComHis" functionid="6+!Q]i*r$;*G-nz`N@%H"/></block></value><next><block type="controls_if" id="t,#I0AyXis_IA+,mh3tg"><mutation else="1"/><value name="IF0"><shadow type="logic_boolean"><field name="BOOL">TRUE</field></shadow><block type="logic_compare" id="~HP24zQ;0m+y$RteP#OK"><field name="OP">LT</field><value name="A"><shadow type="math_number"><field name="NUM">0</field></shadow><block type="variables_get" id="1b/I!;bRR7,=h[Uuw#@Q"><field name="VAR" id="tK-tLChTx?xz=7OxaAMQ">tmp</field></block></value><value name="B"><shadow type="math_number" id="{U-2T^?m-n@RU4?6![Y4"><field name="NUM">0</field></shadow></value></block></value><statement name="DO0"><block type="serial_writestring" id="@7jk%u1kpAQ`4W4ux9QT"><value name="text"><block type="text_join" id=":@A@:fvBA+{gHjuZB6Os"><mutation items="2"/><value name="ADD0"><shadow type="text" id="y!Nl1hWoXgcAlm6,KR=s"><field name="TEXT"> ERR </field></shadow></value><value name="ADD1"><shadow type="text"><field name="TEXT"/></shadow><block type="typescript_expression" id=")Wp4o8Bkl#zzk70tJcTV" editable="false"><field name="EXPRESSION">'\n'</field></block></value></block></value></block></statement><statement name="ELSE"><block type="variables_set" id=":!T9,=zk8g*K98q#bPd4"><field name="VAR" id="E.CPEqpsuDy;8R3s+D,o">delta</field><value name="VALUE"><shadow type="math_number"><field name="NUM">0</field></shadow><block type="variables_get" id="o=K^:aU^f);6FvSX$/nw"><field name="VAR" id="tK-tLChTx?xz=7OxaAMQ">tmp</field></block></value><next><block type="serial_writevalue" id="/b@$i33Z@jQ!-[;wS(IK"><value name="name"><shadow type="text" id="GwVzHoOO?|?p#am}G!Gt"><field name="TEXT">D</field></shadow></value><value name="value"><block type="variables_get" id="K_,B*p9WLDHa$f^8ijl{"><field name="VAR" id="E.CPEqpsuDy;8R3s+D,o">delta</field></block></value><next><block type="serial_writevalue" id="Xi/jNQ!u71)vi0mPmtk^"><value name="name"><shadow type="text" id="1c:Rk98LX@.FLEw9-tUx"><field name="TEXT">L</field></shadow></value><value name="value"><block type="typescript_expression" id="iK4fLP{A*h%vf=2djboR" editable="false"><field name="EXPRESSION">cHistory.getLength()</field></block></value></block></next></block></next></block></statement></block></next></block></statement></block><block type="every_interval" id="O84+?x2vP_ZnH~BGJk+!" x="1353" y="-239"><value name="interval"><shadow type="longTimePicker" id=":wB9w*$MqwScBQ]Gz9)W"><field name="ms">2000</field></shadow></value></block><block type="function_definition" id="lu3~{jvR*)2(4wwN/%4:" x="789" y="-110"><mutation name="compassTick" functionid="ET7PwQ^B5=d$)w)$(V%x"><arg name="angle" id="gjc0fp9w5q7iahc22j9h4" type="number"/></mutation><field name="function_name">compassTick</field><value name="gjc0fp9w5q7iahc22j9h4"><shadow type="argument_reporter_number" id="ks[HO~C45})0u[nLYIbJ"><field name="VALUE">angle</field></shadow></value><statement name="STACK"><block type="variables_set" id="qh`MYpOUL|(?wz^t=%k#"><field name="VAR" id="Lx)SFoC_5Q@iK/:XUMK@">compass</field><value name="VALUE"><shadow type="math_number"><field name="NUM">0</field></shadow><block type="argument_reporter_number" id="v|V$o4zGb`EF1%`uU0,g"><field name="VALUE">angle</field></block></value><next><block type="function_call" id="-6,}ZQN6az?Me!q1c(~="><mutation name="append_ComHis" functionid="`0X8XvtuBff|Z=trjvxM"><arg name="value" id="oiy4osqu15dd9ejlcgvxb" type="number"/></mutation><value name="oiy4osqu15dd9ejlcgvxb"><shadow type="math_number" id="D0W|-$vY%m@CoO_VU]^["><field name="NUM">1</field></shadow><block type="variables_get" id="/EVo~nF3AA7fPHcxc`0x"><field name="VAR" id="Lx)SFoC_5Q@iK/:XUMK@">compass</field></block></value><next><block type="serial_writevalue" id="1K/B%FJ#-+dJ{~72^Fg7"><value name="name"><shadow type="text" id="`Tb_iDP~*^O{@Jb^.`5P"><field name="TEXT">c</field></shadow></value><value name="value"><block type="variables_get" id="?kuVcTZz6e)E6;:f%yTX"><field name="VAR" id="Lx)SFoC_5Q@iK/:XUMK@">compass</field></block></value></block></next></block></next></block></statement></block><block type="function_call" id="e=$zlG(MvW.Wt,Kw=iXc" disabled="true" x="1363" y="-118"><mutation name="compassDelta" functionid="yFcY/IT0#4_MnwtS2RK/"/></block><block type="pxt-on-start" id="4jSbKn8sXe{ZL1$%+{g," x="0" y="0"><statement name="HANDLER"><block type="typescript_statement" id="f=ZZYIB;wtCNIpY:jRTT" editable="false"><mutation xmlns="http://www.w3.org/1999/xhtml" line0="let tmp: number;" numlines="1" declaredvars="tmp"></mutation><next><block type="variables_set" id="$*GCD_07Jgmr*!G.(RL:"><field name="VAR" id="tK-tLChTx?xz=7OxaAMQ">tmp</field><value name="VALUE"><shadow type="math_number" id="p`Bib[if[sv9a3C:Jy;m"><field name="NUM">-100</field></shadow></value><next><block type="typescript_statement" id="`mU_2k|25+7]!JeXRr.;" editable="false"><mutation xmlns="http://www.w3.org/1999/xhtml" line0="let compass: number;" numlines="1" declaredvars="compass"></mutation><next><block type="variables_set" id="EpsRjsyhKg9S$%BcbGMf"><field name="VAR" id="Lx)SFoC_5Q@iK/:XUMK@">compass</field><value name="VALUE"><shadow type="math_number" id="D#p;T0.JrEYe*i];;AZh"><field name="NUM">0</field></shadow></value><next><block type="typescript_statement" id="8Dw|=1f;.KK^!1wIvx0^" editable="false"><mutation xmlns="http://www.w3.org/1999/xhtml" line0="let delta: number;" numlines="1" declaredvars="delta"></mutation><next><block type="variables_set" id="J6FZS{S$2b~4x[f{@3-J"><field name="VAR" id="E.CPEqpsuDy;8R3s+D,o">delta</field><value name="VALUE"><shadow type="math_number" id="Oxf5~XCoiuYK8BdP_FMX"><field name="NUM">0</field></shadow></value><next><block type="typescript_statement" id="PTIk`3NUH.TJ#e33]BK$" editable="false"><mutation xmlns="http://www.w3.org/1999/xhtml" line0="class CorrectionMap {" line1="    private maxKeys: number;" line2="    private maxInRow: number;" line3="    private map: number[][]; // angle index - values count" line4="    private angleList: number[];" line5="    constructor(keys: number, inRow: number) {" line6="        //unused right now" line7="        this.maxKeys = keys;" line8="        // rename to maxEntities" line9="        this.maxInRow = inRow;        " line10="        this.reset();" line11="    }" line12="    private isNewAngle(angle: number) {" line13="        return (this.angleList.indexOf(angle) &lt; 0)" line14="    }" line15="    addAngle(angle: number) {        " line16="        if (this.isNewAngle(angle)) {" line17="            this.map[angle] = [];" line18="            this.map[angle][0] = 0;" line19="            this.angleList.push(angle);" line20="        }" line21="        this.map[angle][0] = this.map[angle][0] + 1;" line22="    }" line23="    private xxx(item: number[], index: number) {" line24="" line25="    }" line26="    removeAngle(angle: number) {" line27="        console.log(&quot;removeAngle(&quot;+angle+&quot;)&quot;)" line28="        if (this.isNewAngle(angle)) {" line29="            console.log(&quot;remAngle&gt; new angle - this should not happen&quot;)" line30="            return false;" line31="        }            " line32="        if (this.map[angle][0] &lt; 1) {" line33="            console.log(&quot;remAngle&gt; clear angle - should not happen&quot;);" line34="            " line35="            //this.map.splice(angle, 1)" line36="            return true;" line37="        } " line38="        console.log(&quot;remAngle(&quot;+ angle +&quot;)&gt; subtrackt angle&quot;);" line39="        this.map[angle][0] = this.map[angle][0] - 1;" line40="        if (this.map[angle][0] == 0) {" line41="            console.log(&quot;remAngle&gt; final cleanup&quot;);" line42="            //this.map.splice(angle, 1)" line43="        }" line44="        return true;" line45="    }" line46="    removeAngleHistory(angle: number) {" line47="        this.map[angle][0] = 0;" line48="    }" line49="    reset() {" line50="        this.map = [];" line51="        this.angleList = [];" line52="    }" line53="    getAll() {" line54="        return this.map;" line55="    }" line56="    getKnownAngles() {" line57="        return this.angleList;" line58="    }" line59="    /*" line60="    for (var key in myArray) {" line61="      console.log(&quot;key &quot; + key + &quot; has value &quot; + myArray[key]);" line62="    }" line63="    */ " line64="}" numlines="65"></mutation><next><block type="typescript_statement" id="YtJ6N:J0HlI*FJ,Lt1lf" editable="false"><mutation xmlns="http://www.w3.org/1999/xhtml" line0="class CompassHistory {" line1="    private maxEntries: number;" line2="    private history: number[];" line3="    private correction: CorrectionMap;" line4="    constructor(max: number) {" line5="        this.history = [];" line6="        this.maxEntries = max;" line7="        this.correction = new CorrectionMap(10, 20);" line8="    }" line9="    append(angle: number) {" line10="        if (this.history.length == this.maxEntries) {" line11="            this.correction.removeAngle(this.history[0]);" line12="            this.history.splice(0, this.history.length - this.maxEntries +1);                        " line13="        }" line14="        this.history.push(angle);" line15="        this.correction.addAngle(angle);" line16="    }" line17="    getDelta(dec: number) {" line18="        if (this.getLength() &lt; 1) return -100;" line19="        let sum = 0;" line20="        this.history.forEach(function (e) {" line21="            sum += e;" line22="        });" line23="        return Math.round( (sum * Math.pow(10, dec)) / this.getLength() ) / Math.pow(10, dec);" line24="    }" line25="    getFromRow() {" line26="        if (this.history.length &gt; 0) {" line27="            return this.history.slice(0,1);" line28="        }" line29="        return -100;" line30="    }" line31="    getLength() {" line32="        return this.history.length;" line33="    }" line34="    reset() {" line35="        this.history = [];" line36="        this.correction.reset();" line37="    }" line38="    getHistory() {" line39="        return this.history" line40="    }" line41="    getCorrection() {" line42="        return this.correction.getAll();" line43="    }" line44="    getKnownAngles() {" line45="        return this.correction.getKnownAngles();" line46="    }" line47="}" numlines="48"></mutation><next><block type="typescript_statement" id="/3tS]d?T4^8V%|RGx}R:" editable="false"><mutation xmlns="http://www.w3.org/1999/xhtml" line0="let cHistory = new CompassHistory(10);" numlines="1" declaredvars="cHistory"></mutation></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></statement></block><block type="function_definition" id="ZD:@v:h#CYRb=IuJPlsd" x="2502" y="-35"><mutation name="reset_ComHis" functionid="I@yZ#SPq`41rt5p-x6=_"/><field name="function_name">reset_ComHis</field><statement name="STACK"><block type="typescript_statement" id="4kh[Yod?MK`paWJ:)EOd" editable="false"><mutation xmlns="http://www.w3.org/1999/xhtml" line0="cHistory.reset();" numlines="1"></mutation></block></statement></block><block type="function_definition" id="%C3sfyZ9ap3Y2]-OjqU=" x="797" y="161"><mutation name="debugCorrection" functionid=",Gl[Zw2[t.t){QN{Ss^Q"/><field name="function_name">debugCorrection</field><statement name="STACK"><block type="typescript_statement" id="V8XGN6]0HYbk?kr;-RiK" editable="false"><mutation xmlns="http://www.w3.org/1999/xhtml" line0="console.log(cHistory.getHistory())" numlines="1"></mutation><next><block type="serial_writevalue" id="|R`$MOFne)zM,o-t7PbA"><value name="name"><shadow type="text" id="yswAd]GDEK}pp]a`ldU1"><field name="TEXT">L</field></shadow></value><value name="value"><block type="typescript_expression" id="Ql*scvGeTi/rI(GNcnp5" editable="false"><field name="EXPRESSION">cHistory.getLength()</field></block></value><next><block type="pxt_controls_for" id="~,8E3_q|rvDXYu%44s!n"><value name="VAR"><shadow type="variables_get_reporter" id="B{8kk9DL96BnwURvs6@c"><field name="VAR" id="LB=Pi9-fR,#9EE35l:3y">i</field></shadow></value><value name="TO"><shadow type="math_whole_number"><field name="NUM">0</field></shadow><block type="math_arithmetic" id="`vP+,d]T(LxdA}3F7G[!"><field name="OP">MINUS</field><value name="A"><shadow type="math_number"><field name="NUM">0</field></shadow><block type="lists_length" id="aN?|nYacY1tH}G^-tBrz"><value name="VALUE"><block type="typescript_expression" id="ph$UjM-oRErnHxLYy57P" editable="false"><field name="EXPRESSION">cHistory.getKnownAngles()</field></block></value></block></value><value name="B"><shadow type="math_number" id="7EDxoU*0v]Zy%p-*j9%a"><field name="NUM">1</field></shadow></value></block></value><statement name="DO"><block type="variables_set" id="R9b+%mB@66N_{#r,.m73"><field name="VAR" id="tK-tLChTx?xz=7OxaAMQ">tmp</field><value name="VALUE"><shadow type="math_number"><field name="NUM">0</field></shadow><block type="lists_index_get" id="H_Am~L)N+#1rJ;%:b2Lh"><value name="LIST"><block type="typescript_expression" id="C#Kep9um.aCuF?HwTEaf" editable="false"><field name="EXPRESSION">cHistory.getKnownAngles()</field></block></value><value name="INDEX"><shadow type="math_number"><field name="NUM">0</field></shadow><block type="variables_get" id="xsBl{s-o]0P6xdgFI@i{"><field name="VAR" id="LB=Pi9-fR,#9EE35l:3y">i</field></block></value></block></value><next><block type="typescript_statement" id="MWnL6XRvh7XB~yQ`|AkV" editable="false"><mutation xmlns="http://www.w3.org/1999/xhtml" line0="console.log(tmp +&quot; [&quot; + cHistory.getCorrection()[tmp][0] + &quot;]&quot;);" numlines="1"></mutation></block></next></block></statement></block></next></block></next></block></statement></block><block type="function_definition" id=",VJhHSEn|[=TmHWAJAfd" x="2496" y="135"><mutation name="getDelta_ComHis" functionid="6+!Q]i*r$;*G-nz`N@%H"/><field name="function_name">getDelta_ComHis</field><statement name="STACK"><block type="function_return" id="IU+//gf$pshFTDDE#J6R"><mutation xmlns="http://www.w3.org/1999/xhtml" no_return_value="false"></mutation><value name="RETURN_VALUE"><shadow type="math_number"><field name="NUM">0</field></shadow><block type="typescript_expression" id="NfHrb7-BFvx~=7[Vu2H}" editable="false"><field name="EXPRESSION">cHistory.getDelta(1)</field></block></value></block></statement></block><block type="function_definition" id="*XZ~9q,*XPk/gj~^(]/)" x="2496" y="316"><mutation name="append_ComHis" functionid="`0X8XvtuBff|Z=trjvxM"><arg name="value" id="oiy4osqu15dd9ejlcgvxb" type="number"/></mutation><field name="function_name">append_ComHis</field><value name="oiy4osqu15dd9ejlcgvxb"><shadow type="argument_reporter_number" id="fsjd3?OHHt!$!Lq?/1hQ"><field name="VALUE">value</field></shadow></value><statement name="STACK"><block type="typescript_statement" id=";TuRUlnJ6)ODFm|J-L:T" editable="false"><mutation xmlns="http://www.w3.org/1999/xhtml" line0="cHistory.append(value);" numlines="1"></mutation></block></statement></block><block type="device_button_event" id="|z1yI.YAPMNBg=j,)Zz/" x="2498" y="496"><field name="NAME">Button.B</field><statement name="HANDLER"><block type="function_call" id="~b9q4!VeEI|AbSdP==~G"><mutation name="reset_ComHis" functionid="I@yZ#SPq`41rt5p-x6=_"/></block></statement></block></xml>